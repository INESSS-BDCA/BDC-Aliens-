---
title: "SQL_CodeActe"
#subtitle: ""
author: "Auteurs: Ahmed Ghachem"
date: "Date de création: 15 décembre 2022"
output:
  rmarkdown::html_vignette:
    number_sections: true
    toc: true
params: 
  output_dir: "C:/Users/MS069/Desktop/Ahmed/INESSS-BDCA/vignettes"
vignette: >
  %\VignetteIndexEntry{SQL_CodeActe}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE,
  eval = FALSE
)
```

# Installation de la librairie R *RequeteGeneriqueBDCA*

## Fichier nécessaire

Télécharger le fichier `RequeteGeneriqueBDCA.x.y.tar.gz` à partir de Microsoft Teams.<br>
[INESSS - Documentation BDCA > Documents > Outils > Librairie R INESSS > RequeteGeneriqueBDCA_x.y.z.tar.gz](https://msss365.sharepoint.com/:f:/r/teams/INESSS-DocumentationBDCA/Shared%20Documents/Outils/Librairie%20R%20INESSS?csf=1&web=1&e=j5SylU).

Ouvrir RStudio.

Dans la console, écrire le code suivant :
```{r, eval=FALSE}
remotes::install_local("C:\\msXXX\\Desktop\\RequeteGeneriqueBDCA_x.y.z.tar.gz")
```
Prendre note que les «`\`» sont doubles.

Si la librairie `remotes` n'est pas installée, écrire dans la console le code suivant : `install.packages("remotes")`.

Avant d'installer une librairie, il est préférable de ne pas l'avoir *appelé* auparavant.

Il est déconseillé de mettre à jour les librairies utilisées par *RequeteGeneriqueBDCA*.

L'installation se termine lorsqu'on peut lire dans la console : *DONE (RequeteGeneriqueBDCA)*.


## Activer la librairie
      
Après avoir installé la librairie *RequeteGeneriqueBDCA*, il suffit de l'activer pour avoir accès aux fonctions :
```{r, eval=FALSE}
library(RequeteGeneriqueBDCA)
```

---

# SQL_CodeActe

La fonction `SQL_CodeActe` est une `child_function` qui permet d'extraire des actes entre une date de début et de fin d'une étude. Elle appelle plusieurs  fonctions `parent_function` génériques telles que:<br/> 
[SQL_reperage_cond_med](SQL_reperage_cond_med.html),<br/> 
[query_I_SMOD_SERV_MD_CM_AG](query_I_SMOD_SERV_MD_CM_AG.html),<br/>
[query_V_FICH_ID_BEN_CM](query_V_FICH_ID_BEN_CM.html)<br/>

Trois principales étapes sont effectuées: <br/>
1) la création de la cohorte de l'étude en utilisant les Dx cim-9 et/ou cim-10 via la fonction `SQL_reperage_cond_med`<br/> 
2) l'extraction des actes pour cette cohorte via la fonction `query_I_SMOD_SERV_MD_CM_AG`<br/>
3) l'ajout des caractéristiques des benéficiaires ainsi que l'établissement de soins. Les caractéristiques des bénéficiaires et de l'établissement de soins pour les personnes ayant eu un code d'acte à l'intérieur de la période de l'étude sont extraits via la fonction `query_I_SMOD_SERV_MD_CM_AG`, alors que pour ceux qui n'ont pas eu d'acte, leurs caractéristiques sont extraits via la fonction `query_V_FICH_ID_BEN_CM`.    

## Usage de la fonction

```{r, eval=FALSE}
SQL_CodeActe(conn=SQL_connexion(),
             cohort,
             debut,
             fin,
             CodeActe,
             omni_spec,
             Dx_table,
             CIM,
             by_Dx,
             nDx,
             date_dx_var,
             n1,n2,
             date_age,
             verbose,
             keep_all)
```

## Définition des arguments
### conn
La fonction `SQL_connexion` permet à R de se connecter à Teradata. Simplenent inscrire l'identifant et le programme demandera le mot de passe lors de son exécution :
```{r}
conn = SQL_connexion("msXXX")
```

### cohorte
Vecteur indiquant les numéros d'identification des bénéficiaires définisant la cohorte de l'étude.
```{r}
cohort<-cohort$BENF_NO_INDIV_BEN_BANLS
```

### debut & fin
Date de début et de fin de la période d'étude au format AAAA-MM-JJ.
```{r}
debut = "2020-01-01" 
fin = "2020-12-31"
```

### codeActe
Vecteur comprenant les codes d'acte d'interêt.
```{r}
CodeActe = c('06452','06148','06154','06265','06251','06216','06208','06164','06270','06276')
```

### omni_spec
Permet d'extraire les actes facturés par les omnipraticiens et/ou les spécialistes.
```{r}
omni_spec="all"
omni_spec="omni"
omni_spec="spec"
```

### Dx_table
`list` contenant les codes diagnostics CIM9 et CIM10.
```{r}
Dx_table = list(
  diabete = list(
    CIM9 = c("2500%", "2501%", "2502%"),
    CIM10 = c("E100%", "E101%", "E109%", "E110%", "E111%", "E119%", "E130%",
              "E131%", "E139%", "E140%", "E141%", "E149%")),
  diabete_complication = list(
    CIM9 = paste0(2503:2509, "%"),
    CIM10 = paste0("E", c(102:108, 112:118, 132:138, 142:148), "%")
  )
)
```

### CIM
Permet de choisir le type de code diagnostic : CIM9, CIM10 ou les deux.
```{r}
CIM = c("CIM9", "CIM10")  # par défaut : CIM9 et CIM10
CIM = "CIM9"  # CIM9 seulement
CIM = "CIM10"  # CIM10 seulement
```

### by_Dx
Vrai (`TRUE`) ou FAUX (`FALSE`).  

À partir de `DX_table` créé précédemment, si `TRUE`, on aurait au maximum deux lignes par individu où la colonne `DIAGN` indiquerait `diabete` ou `diabete_complication`.  
Si `FALSE`, on a au maximum une ligne par individu et la colonne `DIAGN` est absente, car les codes de `diabete` et `diabete_complication` sont considérés comme un seul élément d'analyse dans l'algorithme.
```{r}
by_Dx = TRUE  # par défaut
by_Dx = FALSE
```

### date_dx_var
Permet de choisir entre la date d'admission ou la date de départ comme date d'incidence dans les vues suivantes :

* V_DIAGN_SEJ_HOSP_CM
* V_SEJ_SERV_HOSP_CM
* V_EPISO_SOIN_DURG_CM

```{r}
date_dx_var = "admis"  # par défaut
date_dx_var = "depar"
```

### nDx
Permet de choisir le nombre de diagnostic qui permet de confirmer le premier.
```{r}
nDX=1 # par défaut
```

### n1 & n2
Permet de créer l'intervalle `[n1, n2]`. Le nombre de jours entre deux diagnostics doit se situer dans cet intervalle pour que le deuxième diagnostic confirme le premier.
```{r}
n1 = 30 
n2 = 730
```

### date_age 
Permet d'indiquer une date `"AAAA-MM-JJ"` à laquelle l'âge des bénéficaires qui n'ont pas eu d'acte est calculé.
```{r}
date_age="2022-03-01"
```
### verbose
`TRUE` ou `FALSE`. Message de progression affiché dans la console.

Création de la cohorte:<br/>
nDx=0 : Extraction des résultats (Pas de confirmation nécessaire).<br/>
V_DIAGN_SEJ_HOSP_CM <br/>
 - Prolapsus (2.92 secs)<br/>
V_SEJ_SERV_HOSP_CM <br/>
 - Prolapsus (1.47 secs)<br/>
V_EPISO_SOIN_DURG_CM <br/>
 - Prolapsus (2.32 secs)<br/>
I_SMOD_SERV_MD_CM <br/>
 - Prolapsus (7.82 secs)
Arrangement de la table finale...<br/>
FIN de création de la cohorte.<br/>
Extraction des actes:<br/>
 - Temps d'exécution (15.18 secs)<br/>
Ajout des caractéristiques des bénéficiaires qui n'ont pas eu d'acte dans la période d'étude:<br/>
 - Temps d'exécution (5.27 mins)<br/>
Préparation de la base de données finale:<br/>
 - Temps d'exécution (9.36 secs)<br/>


### keep_all
`TRUE` ou `FALSE`. Par défaut `FALSE`, soit filter les observations ayant eu un DX et un code d'acte. Si `TRUE` garder toutes les observations, soit ceux qui ont eu un DX et qui ont eu ou pas un code d'acte. Si `cohort` est fournit, keep_all `TRUE` garde toutes les observations demandées par `cohort`. Si keep_all `FALSE` filtrer les observations demandées par `cohort`qui ont eu un code d'acte.

---
# Table Résultante
## Variables

- **ID** : Numéro d'identification du bénéficiaire. <br/>
- **DI_Finale** : Date d'incidence retenue. <br/>
- **D_Recent** : Date la plus récente observée. </br> 
- **AnFinan** : Année financière de l'acte. <br/>
- **AnCivil** : Année civile de l'acte. <br/>
- **DateActe** : Date  de l'acte au format *AAAA-MM-JJ*. <br/>
- **CodeActe** : Actes demandés dans l'argument CodeActe. <br/>
- **CoutActe** : Cout de l'acte. <br/>
- **DxActe** : Diagnostique associé à l'acte. <br/>
- **Num_ETAB_USUEL** : Numéro de l'établissement. <br/>
- **CodEntente** : Code d'entente sert à associer les dispensateurs à un groupe spécifique.Voir domaine de valeur:[SMOD_COD_ENTEN](https://msss365.sharepoint.com/teams/INESSS-DocumentationBDCA/Lists/Var/DispForm.aspx?ID=181) <br/>
- **SecActiv** : Identifie de façon unique chacun des secteurs d'activités dans lesquels les différents établissements peuvent oeuvrer.Voir domain de valeur [ETAB_COD_SECT_ACTIV_ETAB](https://msss365.sharepoint.com/teams/INESSS-DocumentationBDCA/Lists/Var/DispForm.aspx?ID=206)<br/>
- **NumDispSp** : Numéro de dispensateur. <br/>
- **SPDisp_smod** : Spécialité de dispensateur indiqué dans `SMOD`. <br/>
- **SPDisp_fip** : Spécialité de dispensateur indiqué dans `FIP`. <br/>
- **NumDispRef** : Numéro de dispensateur référent. <br/>
- **SPDispRefs** : Spécialité de dispensateur référent. <br/>
- **NO_ETAB** : Numéro de l'établissement. <br/>
- **Cat_Etab** Catégorie de l'établissement. <br/>
- **NOM_ETAB** : Nom de l'établissement. <br/>
- **RSS_Etab** : Régions sociosanitaires (RSS) de l'établissement. <br/>
- **RLS_Etab** : Réseaux locaux de services (RLS) de l'établissement. <br/>
- **NomRSS_Etab** : Nom régions sociosanitaires (RSS) de l'établissement. <br/>
- **NomRLS_Etab** : Nom réseaux locaux de services (RLS) de l'établissement. <br/>
- **Sexe** : Sexe du bénéficiaire. <br/>
- **DatNais** : Date de naissance du bénéficiaire au format *AAAA-MM-JJ*. <br/>
- **datdeces** : Date de décès du bénéficiaire au format *AAAA-MM-JJ*. <br/>
- **Age** : Age du bénéficiaire calculé jusqu'à la date de l'acte. <br/>
- **RSS_Benf** : Régions sociosanitaires (RSS) du bénéficiaire. <br/>
- **RLS_Benef** : Réseaux locaux de services (RLS) du bénéficiaire. <br/>
- **NomRSS_Benef** : Nom régions sociosanitaires (RSS) du bénéficiaire. <br/>
- **NomRLS_Benef** : Nom réseaux locaux de services (RLS) du bénéficiaire. <br/>

***
# Discription de la syntaxe SQL
    
Veuillez-svp consulter les vignettes des `parent_function` suivantes:

[SQL_reperage_cond_med](SQL_reperage_cond_med.html)<br/> 
[query_I_SMOD_SERV_MD_CM_AG](query_I_SMOD_SERV_MD_CM_AG.html)<br/>
[query_V_FICH_ID_BEN_CM](query_V_FICH_ID_BEN_CM.html)<br/>
