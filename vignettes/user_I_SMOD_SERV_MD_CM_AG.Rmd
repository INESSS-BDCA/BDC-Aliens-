---
title: "user_I_SMOD_SERV_MD_CM_AG"
#subtitle: ""
author: "Auteurs: Ahmed Ghachem"
date: "Date de création: 22 février 2023"
# output:
#   rmarkdown::html_vignette:
output:
  rmarkdown::html_vignette:
    css: styles.css
    #self_contained: false
    number_sections: true
    toc: true
params: 
  output_dir: "vignettes"
vignette: >
  %\VignetteIndexEntry{user_I_SMOD_SERV_MD_CM_AG}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE,
  eval = FALSE
)
```

# Installation de la librairie R *RequeteGeneriqueBDCA*

## Fichier nécessaire

Télécharger le fichier `RequeteGeneriqueBDCA.x.y.tar.gz` à partir de Microsoft Teams.<br>
[INESSS - Documentation BDCA > Documents > Outils > Librairie R INESSS > RequeteGeneriqueBDCA_x.y.z.tar.gz](https://msss365.sharepoint.com/:f:/r/teams/INESSS-DocumentationBDCA/Shared%20Documents/Outils/Librairie%20R%20INESSS?csf=1&web=1&e=j5SylU).

Ouvrir RStudio.

Dans la console, écrire le code suivant :
```{r, eval=FALSE}
remotes::install_local("C:\\msXXX\\Desktop\\RequeteGeneriqueBDCA_x.y.z.tar.gz")
```
Prendre note que les «`\`» sont doubles.

Si la librairie `remotes` n'est pas installée, écrire dans la console le code suivant : `install.packages("remotes")`.

Avant d'installer une librairie, il est préférable de ne pas l'avoir *appelé* auparavant.

Il est déconseillé de mettre à jour les librairies utilisées par *RequeteGeneriqueBDCA*.

L'installation se termine lorsqu'on peut lire dans la console : *DONE (RequeteGeneriqueBDCA)*.


## Activer la librairie
      
Après avoir installé la librairie *RequeteGeneriqueBDCA*, il suffit de l'activer pour avoir accès aux fonctions :
```{r, eval=FALSE}
library(RequeteGeneriqueBDCA)
```

---

# user_I_SMOD_SERV_MD_CM_AG

La fonction `user_I_SMOD_SERV_MD_CM_AG` est destinée aux utilisateurs. Elle permet: <br/>

1) d'extraire les variables pertinantes de la base de données SMOD, jumlées avec d'autres bases de données pour rajouter les caractéristiques de dispensateur, du bénéficiaire et de l'établissement de soins. <br/>
2) d'effectuer des analyses déscriptives des actes médicaux. <br/>

La fonction `user_I_SMOD_SERV_MD_CM_AG` est une `child_function` qui permet d'exécuter les requêtes SQL générées par les `parent_function` suivantes:<br/>
[SQL_reperage_cond_med](SQL_reperage_cond_med.html)<br/>
[query_I_SMOD_SERV_MD_CM_AG](query_I_SMOD_SERV_MD_CM_AG.html)<br/>
[query_V_FICH_ID_BEN_CM](query_V_FICH_ID_BEN_CM.html)<br/>

Si la cohorte n'est pas fournie par le professionnel scientifique, et on veut créer une cohorte en utilisant les Dx cim-9 et/ou cim-10:<br/>

si `task="extraction_SMOD"`:
la fonction `user_I_SMOD_SERV_MD_CM_AG` exécute trois étapes principales: <br/>
1) la création de la cohorte de l'étude en utilisant les Dx cim-9 et/ou cim-10 via la fonction `SQL_reperage_cond_med`<br/> 
2) l'extraction des actes pour cette cohorte via la fonction `query_I_SMOD_SERV_MD_CM_AG`<br/>
3) l'ajout des caractéristiques de benéficiaire, de dispensateur, ainsi que de l'établissement de soins.<br/> 

si `task="projet_factuartion_acte"`: <br/>
4) la production des tableaux et figures pour les analyses déscriptives des actes médicaux.<br/>  

Si la cohorte n'est pas fournie par le professionnel scientifique, et on ne veut pas créer une cohorte en utilisant les Dx cim-9 et/ou cim-10: <br/>
l'étape 1 est ignorée et les étapes 2, 3 et 4 sont exécutées en fonction de la nature de l'argument `task` <br/> 

## La fonction

```{r, eval=FALSE}
user_I_SMOD_SERV_MD_CM_AG(task,
                          conn=SQL_connexion(),
                          cohort=NULL, # si la cohorte est fournie par l'analyste (cohort=cohort), si on veut créer une nouvelle cohorte (cohort=NULL)
                          debut_periode,
                          fin_periode,
                          
                          CodeActe,
                          omni_spec,
                          catg_etab, 
                          code_stat_decis,
                          
                          benef_adr,
                          date_adr, # à spécifier lorsque benef_adr="date_fixe"
                          date_age, # à spécifier lorsque keep_all=TRUE
                          
                          Dx_table, # si la cohorte n'est pas fournie par le professionnel scientifique et nous ne voulons pas créer une nouvelle cohorte (Dx_table=NULL)
                          debut_cohort,
                          fin_cohort,
                          CIM,
                          by_Dx,
                          date_dx_var,
                          n1,n2,
                          nDx,
                          keep_all=FALSE,
                          
                          setwd,
                          verbose=TRUE)

```

## Définition des arguments
### task 
Permet de préciser le type de requête à exécuter.
```{r}
task = c("extraction_SMOD","Projet_Factuartion_Acte")
```

### Connexion
La fonction `SQL_connexion` permet à R de se connecter à Teradata. Simplenent inscrire l'identifant et le programme demandera le mot de passe lors de son exécution :
```{r}
conn = SQL_connexion("msXXX")
```

### Cohorte
* Si cohorte = NULL (il n'y a pas de cohorte prédéfinie) : extraction d'acte pour tous ceux ayant eu une date d'acte à l'intérieure de la période d'étude. <br/> 
* Si cohorte = cohorte (il y a une cohorte prédéfinie): extraction d'acte pour les individus de la cohorte prédéfinie ayant eu une date d'acte à l'intérieure de la période d'étude. <br/> 
* Si CRÉATION D'UNE COHORTE: <br/> 
Étape 1 - création d'une cohorte en utilisant l'algorithme SQL_reperage_cond_med. <br/> 
Étape 2 - extraction d'acte pour les individus de la cohorte crée ayant une date d'acte à l'intérieure de la période de l'étude. <br/> 
* Si vous avez une cohorte prédéfinie ou une cohorte crée, vous devez mentionner si vous voulez selectionner tous les individus de la cohorte ayant eu ou non un acte à l'intérieure de la période d'étude 'keep_all=TRUE'. <br/> 

```{r}
cohort=NULL
# Ou
cohort<-DT$BENF_NO_INDIV_BEN_BANLS # Vecteur indiquant les numéros d'identification des bénéficiaires définisant la cohorte de l'étude
cohort=cohort
```

### Période de l'étude
Date de début et de fin de la période d'étude au format AAAA-MM-JJ.
```{r}
debut_periode = "2020-01-01" 
fin_periode = "2020-12-31"
```


### Paramètres spécifiques de la requête
#### codeActe
Vecteur comprenant les codes d'acte d'interêt.
```{r}
CodeActe = c('06452','06148','06154','06265','06251','06216','06208','06164','06270','06276')
```

#### omni_spec
Permet d'extraire les actes facturés par les omnipraticiens et/ou les spécialistes.
```{r}
omni_spec="all"
omni_spec="omni"
omni_spec="spec"

# code sql:
# Si omni_spec="omni": AND BD_SMOD.SMOD_COD_SPEC IS NULL 
# Si omni_spec="spec": AND BD_SMOD.SMOD_COD_SPEC IS NOT NULL 
```

#### catg_etab
Permet d'extraire les dates de visites selon la catégorie de l'établissement.
```{r, eval=FALSE}
catg_etab="all" # les visites effectuées dans toutes les catégories d'établissement confondues
catg_etab="ambulatoire" # les visites effectuées en ambilatoire

# Code sql:
# Si catg_etab="ambulatoire"; AND (BD_Etab.ETAB_COD_CATG_ETAB_EI IN ('54X', '55X', '57X', '9X2', '8X5', '4X1','0X1') OR BD_SMOD.SMOD_NO_ETAB_USUEL IS NULL)
```

#### code_stat_decis
Permet d'extraire les actes selon leurs statuts de paiement.
```{r}
code_stat_decis=c("PAY","PPY")
```


### Caractéristiques du bénéficiaires
#### Adresse du bénéficiaire
Permet d'indiquer la méthode d'identification de l'adresse du bénéficiaire (défaut=dernière_adresse). <br/>
Si Adresse du bénéficiaire = date_fixe, indiquer une date (AAAA-MM-JJ) dans 'Date adresse'
```{r}
benef_adr=c("date_fixe","dernière_adresse","première_adresse","long_adresse","date_acte")

# code sql:
# si benef_adr="date_fixe": AND '",date_adr,"' between BENF_DD_ADR_BEN AND BENF_DF_ADR_BEN
# si benef_adr="dernière_adresse": QUALIFY Row_Number()Over (PARTITION BY BENF_NO_INDIV_BEN_BANLS ORDER BY BENF_DD_ADR_BEN DESC)=1
# si benef_adr="première_adresse": QUALIFY Row_Number()Over (PARTITION BY BENF_NO_INDIV_BEN_BANLS ORDER BY BENF_DD_ADR_BEN ASC)=1 
# si benef_adr="long_adresse":
# CASE
# WHEN (BENF_DD_ADR_BEN <= '",debut,"' AND BENF_DF_ADR_BEN >= '",fin,"') THEN DATE '",fin,"' - DATE '",debut,"' + 1
# WHEN (BENF_DD_ADR_BEN >= '",debut,"' AND BENF_DF_ADR_BEN >= '",fin,"') THEN DATE '",fin,"' - BENF_DD_ADR_BEN
# WHEN (BENF_DD_ADR_BEN <= '",debut,"' AND BENF_DF_ADR_BEN <= '",fin,"') THEN BENF_DF_ADR_BEN - DATE '",debut,"'
# WHEN (BENF_DD_ADR_BEN >= '",debut,"' AND BENF_DF_ADR_BEN <= '",fin,"') THEN BENF_DF_ADR_BEN - BENF_DD_ADR_BEN
# ELSE 0
# END AS days_count,
# ROW_NUMBER() OVER (PARTITION BY BENF_NO_INDIV_BEN_BANLS ORDER BY days_count DESC) AS row_num
# WHERE A.row_num=1

```

#### Date adresse
Si `benef_adr`="date_fixe", `date_adr` permet de choisir une date fixe pour identifier l'adresse du bénéficiaire. 
```{r}
date_adr="2020-07-01"
```

#### Date âge 
Permet d'indiquer une date `"AAAA-MM-JJ"` à laquelle l'âge des bénéficaires qui n'ont pas eu d'acte est calculé. L'âge de bénéficiaires qui ont eu un acte à l'intérieur de la période de l'étude est calculé à la date de l'acte.  
```{r}
date_age="2020-03-01"
```


### PARAMÈTRES POUR LA CRÉATION DE LA COHORTE AVEC `SQL_reperage_cond_med`
#### Liste des diagnostics
Permet d'indiquer la liste des diagnostics de la condition médicale à utiliser pour la création de la cohorte. 
```{r}
Dx_table = list(
  diabete = list(
    CIM9 = c("2500%", "2501%", "2502%"),
    CIM10 = c("E100%", "E101%", "E109%", "E110%", "E111%", "E119%", "E130%",
              "E131%", "E139%", "E140%", "E141%", "E149%")),
  diabete_complication = list(
    CIM9 = paste0(2503:2509, "%"),
    CIM10 = paste0("E", c(102:108, 112:118, 132:138, 142:148), "%")
  )
)
```

#### Classification des diagnostics
Permet d'indiquer la classification des diagnostics à utiliser (CIM9, CIM10 ou les deux).
```{r}
CIM = c("CIM9", "CIM10")  # par défaut : CIM9 et CIM10
CIM = "CIM9"  # CIM9 seulement
CIM = "CIM10"  # CIM10 seulement
```

#### Date début et fin de la cohorte
Date de début et de fin de la création d'une cohort au format AAAA-MM-JJ.
```{r}
debut_cohort = "2018-01-01" 
fin_cohort = "2020-12-31"
```


#### Stratification de la cohorte 
Permet d'indiquer si la cohorte doit être stratifiée ou non selon les conditions médicales définies dans la liste des diagnostics. <br/>
À partir de `DX_table` créé précédemment, si `TRUE`, on aurait au maximum deux lignes par individu où la colonne `DIAGN` indiquerait `diabete` ou `diabete_complication`. <br/> 
Si `FALSE`, on a au maximum une ligne par individu et la colonne `DIAGN` est absente, car les codes de `diabete` et `diabete_complication` sont considérés comme un seul élément d'analyse dans l'algorithme.
```{r}
by_Dx = FALSE # par défaut
by_Dx = TRUE  
```

#### Date d'admission ou de départ 
Permet d'indiquer si on doit utiliser la date d’admission ou de départ comme date d’incidence lors des hospitalisations ou des visites à l’urgence: <br/> 

* V_DIAGN_SEJ_HOSP_CM
* V_SEJ_SERV_HOSP_CM
* V_EPISO_SOIN_DURG_CM

```{r}
date_dx_var = "admis"  # par défaut
date_dx_var = "depar"
```

### Paramètres de l'algorithme de création de cohorte
Permet d'indiquer les paramètres de l’algorithme soit : le nombre de jours (n1) entre 2 diagnostics, la période de temps (n2) à considérer pour confirmer le premier diagnostic et le nombre minimum d’occurrences du diagnostic pour confirmer la condition (nDx). (Valeurs par défaut n1= 30 jours, n2= 730 jours et nDx=1)<br/>

#### Nombre de jours (n1 & n2)
Permet d'indiquer le nombre de jours entre lesquels deux diagnostics doit se situer pour que le deuxième Dx confirme le premier.
```{r}
n1 = 30 
n2 = 730
```

#### Nombre d'occurence (nDx)
Permet d'indiquer le nombre de diagnostic qui permet de confirmer le premier.
```{r}
nDX=1 # par défaut
```

### Cas retenus
#### keep_all
Permet de selectionner les cas retenus.
```{r}
keep_all= FALSE # Par défaut, keep_all = FALSE, soit selectionner seulement les personnes avec un acte
keep_all=TRUE #selectionner toutes les personnes de la cohorte prédéfinie ou crée
```


### setwd 
Permet d'indiquer le chemin vers le dossier dans lequel les résultats de la fonction seront sauvegardés. Si `setwd`="NULL", les résultats seront seulement affichés dans l'environnement du Rstudio.  
```{r}
setwd="V:/GI/Projets/4.Projets_en_cours/Nom_dossier"
```

### verbose
```{r}
verbose= TRUE # Par défault verbose=TRUE, un message de progression est affiché
verbose= FALSE 
```

Étape 1: Extraction des actes pour les bénéficiaires ayant eu un acte à l'intérieure de la péride de l'étude:<br/>
- Temps d'exécution (30.24 secs)<br/> 
 
Étape 2: Préparation de la base de données finale:<br/>
Garder les IDs qui ont eu un code d'acte à l'intérieure de la période de l'étude<br/> 

Étape 3: Rajouter les étiquettes pour `SMOD_COD_ROLE`, `SMOD_COD_SPEC`, `ETAB_COD_SECT_ACTIV_ETAB`, `SMOD_COD_ENTEN` et `Dx`:<br/>
- Temps d'exécution (0.84 secs)<br/> 
 
Étape 4: Préparation des tableaux et des figures pour les analyses discriptives des actes:<br/>
Tableau 1: Variation du nombre d'acte par année civille <br/>
- Temps d'exécution (0.67 secs)<br/> 
 
Tableau 2: Variation du nombre d'acte par spécialité de dispensateur <br/>
- Temps d'exécution (0.04 secs)<br/> 
 
Tableau 3: Variation du nombre d'acte par lieu de service <br/>
- Temps d'exécution (0.05 secs)<br/> 
 
Tableau 4: Fréquence des combinaisons d'actes facturés par le même disp, à la même date pour le même benef<br/>
- Temps d'exécution (2.18 secs)<br/> 
 
Tableau 5: Nombre de répétion d'acte  par (ID, DateActe, NumDispSp) et (ID, DateActe)<br/>
- Temps d'exécution (1.02 secs)<br/> 
 
Figure 1: variation des coûts de facturation par acte <br/>  
 
Étape 5: Sauvegarde des BD et figures dans: C:/Users/MS069/Desktop/Ahmed/Pojet_Factur_Acte<br/> 




## Usage de la fonction
```{r}
DT_final<-user_I_SMOD_SERV_MD_CM_AG(
  task=c("extraction_SMOD","Projet_Factuartion_Acte"), 
  conn=SQL_connexion("ms069a"), 
  cohort = NULL, 
  debut_periode = "2020-01-01",
  fin_periode = "2020-12-31",
  
  CodeActe=c('06452','06148','06154','06265','06251','06216'),
  omni_spec="all",
  catg_etab="all",
  code_stat_decis=c("PAY","PPY"),
  
  benef_adr="dernière_adresse",
  date_adr="2021-07-01",
  date_age="2020-07-01",
  
  Dx_table=NULL,# list contenant les codes diagnostics CIM9 et CIM10. Exemple: Dx_table = list(Coronaro = list(CIM9 = paste0(c(491, 492, 496), '%'), CIM10 = paste0('J', 41:44, '%'))),
  debut_cohort = "2018-01-01",
  fin_cohort = "2020-12-31",
  CIM =  c("CIM9", "CIM10"),
  by_Dx = FALSE,
  date_dx_var = "admis",
  n1 = 30, n2 = 730,
  nDx = 0,
  keep_all=FALSE,
  
  setwd="C:/Users/MS069/Desktop/Ahmed/Pojet_Factur_Acte",
  verbose = TRUE
)
```


# Table Résultante
## `task="extraction_SMOD"`
 Extraction des variables pertinantes de SMOD combinées avec les caractéristiques du bénéf et de l'établissement. Une base de données avec 39 à 41 variables.

- **ID** : Numéro d'identification du bénéficiaire. <br/>
- **DI_Finale** : Date d'incidence retenue. # Sil y a création d'une nouvelle cohorte <br/>
- **D_Recent** : Date la plus récente observée. # Sil y a création d'une nouvelle cohorte <br/>
- **Sexe** : Sexe du bénéficiaire. <br/>
- **DatNais** : Date de naissance du bénéficiaire au format *AAAA-MM-JJ*. <br/>
- **Datdeces** : Date de décès du bénéficiaire au format *AAAA-MM-JJ*. <br/>
- **Age** : Age du bénéficiaire calculé jusqu'à la date de l'acte. <br/>
- **Code_RSS_Benf** : Régions sociosanitaires (RSS) du bénéficiaire. <br/>
- **Desc_RSS_Benef** : Nom régions sociosanitaires (RSS) du bénéficiaire. <br/>
- **Code_RLS_Benef** : Réseaux locaux de services (RLS) du bénéficiaire. <br/>
- **Desc_RLS_Benef** : Nom réseaux locaux de services (RLS) du bénéficiaire. <br/>
- **AnFinan** : Année financière de l'acte. <br/>
- **AnCivil** : Année civile de l'acte. <br/>
- **DateActe** : Date  de l'acte au format *AAAA-MM-JJ*. <br/>
- **Code_Acte** : Actes demandés dans l'argument CodeActe. <br/>
- **Cout_Acte** : Cout de l'acte. <br/>
- **Code_DxActe** : Diagnostique associé à l'acte. <br/>
- **SMOD_COD_ROLE** : Code des rôles selon l'entent. <br/>
- **Desc_SMOD_COD_ROLE** : Description Code des rôles selon l'entent. <br/>
- **SMOD_COD_ENTEN** : Code d'entente sert à associer les dispensateurs à un groupe spécifique.Voir domaine de valeur:[SMOD_COD_ENTEN](https://msss365.sharepoint.com/teams/INESSS-DocumentationBDCA/Lists/Var/DispForm.aspx?ID=181) <br/>
- **Desc_SMOD_COD_ENTEN** : Description de Code d'entente sert à associer les dispensateurs à un groupe spécifique.<br/>
- **NumDispSp** : Numéro de dispensateur. <br/>
- **Code_SpecSmod** : Spécialité de dispensateur indiqué dans `SMOD`. <br/>
- **Desc_SpecSmod** : Description Spécialité de dispensateur indiqué dans `SMOD`. <br/>
- **Code_Specfip** : Spécialité de dispensateur indiqué dans `FIP`. <br/>
- **Desc_Specfip** : Description Spécialité de dispensateur indiqué dans `FIP`. <br/>
- **NumDispRef** : Numéro de dispensateur référent. <br/>
- **Code_SpecDispRef** : Spécialité de dispensateur référent. <br/>
- **Desc_SpecDispRef** : Description Spécialité de dispensateur référent. <br/>
- **NumEtabUsuel** : Numéro de l'établissement. <br/>
- **NumEtab** : Numéro de l'établissement. <br/>
- **NomEtab** : Nom de l'établissement. <br/>
- **Code_SectActiv** : Identifie de façon unique chacun des secteurs d'activités dans lesquels les différents établissements peuvent oeuvrer.Voir domain de valeur [ETAB_COD_SECT_ACTIV_ETAB](https://msss365.sharepoint.com/teams/INESSS-DocumentationBDCA/Lists/Var/DispForm.aspx?ID=206)<br/>
- **Desc_SectActiv** : Description des secteurs d'activités dans lesquels les différents établissements peuvent oeuvrer.<br/>
- **Desc_SectActivRegroup** : Description des secteurs d'activités regroupés dans lesquels les différents établissements peuvent oeuvrer.<br/>
- **Code_CatEtab** Catégorie de l'établissement. <br/>
- **Code_RSS_Etab** : Régions sociosanitaires (RSS) de l'établissement. <br/>
- **Desc_RSS_Etab** : Nom régions sociosanitaires (RSS) de l'établissement. <br/>
- **Code_RLS_Etab** : Réseaux locaux de services (RLS) de l'établissement. <br/>
- **Desc_RLS_Etab** : Nom réseaux locaux de services (RLS) de l'établissement. <br/>


## `task="projet_factuartion_acte"`
La même table résultante que `task`="extraction_SMOD" + Analyses descriptives des actes médicaux. Une base de données de 39 variables avec 5 tableaux et deux figures. <br/>
Les résultats de la `task`="projet_factuartion_acte" seront sous forme d'une liste `DT_final` avec 6 éléments, soient: <br/> 

**DT_final**: Base de données incluant les variables extraites via la `task`="extraction_SMOD_combin" <br/> 
**Tableau 1**: Variation du nombre d'acte par année civille <br/> 
**Tableau 2**: Variation du nombre d'acte par spécialité de dispensateur <br/> 
**Tableau 3**: Variation du nombre d'acte par lieu de service <br/>
**Tableau 4**: Fréquence des combinaisons d'actes facturés par le même disp, à la même date pour le même benef<br/>
**Tableau 5**: Nombre de répétion d'acte  par (ID, DateActe, NumDispSp) et (ID, DateActe) <br/>
**Figure 1**: Variation des coûts de facturation par acte selon la spécialité de dispensateur <br/> 
**Figure 2**: Variation des coûts de facturation par acte selon la spécialité de dispensateur: anesthésiologiste <br/> 


# Discription de la syntaxe SQL
Veuillez-svp consulter les vignettes `parent_function` suivantes:<br/>

[SQL_reperage_cond_med](SQL_reperage_cond_med.html)<br/> 
[query_I_SMOD_SERV_MD_CM_AG](query_I_SMOD_SERV_MD_CM_AG.html)<br/>
[query_V_FICH_ID_BEN_CM](query_V_FICH_ID_BEN_CM.html)<br/>
